### Задание

Написать скрипт, который открывает URL, считывает оттуда тело ответа и записывает его в файл.

1. Он должен принимать URL в формате: http://ya.ru, в качестве параметра при запуске.
2. И он должен принимать как параметр при запуске путь к файлу, куда записать тело.

## Настройка Python окружения

Чтобы можно было работать с Python на linux, надо 3 пакета:

```bash
python-dev
python-pip
python-virtualenv
```

Установка пакетов:

```bash
sudo apt-get install ...
```

Чтобы создать копию окружения Python:

```bash
virtualenv env
env/bin/python
env/bin/pip install requests
```

Чтобы не вводить env/bin в 1 сессии терминала можно набрать команду:

```bash
source env/bin/activate
```

Потом вызов:

```bash
python будет вызывать python из env/bin
```

Далее есть файлик, в котором хранятся все зависимости.

`<package>==<version>` - Ссылается на определенную версию
`<package>` - Ссылается на последнюю версию

Установка всех зависимостей из requirements:
```bash
env/bin/pip install -r requirements.txt
```

Пакеты можно искать тут:
https://pypi.python.org/pypi

### Задание

1. Сделать virtualenv.
2. Надо все сторонние зависимости записать в файл.
3. Добавить зависимость для HTTP сервера (wsgi).
4. Сделать Makefile, который будет сам запускать создание virtualenv и ставить пакеты.

## HTTP Server

Пример URL:
http://host:8080/path?query=133

Примеры URI:
POST /path/to/resource?query=123
GET /1234/

У HTTP есть разные виды запросов:
POST - это запрос с телом (JSON, Binary, XML), если объект существует
GET - в нем нет тела.

PUT - используется для создания объектов.
DELETE - удаление объекта.

HEAD - он для получения только заголовков. GET который не возвращает тело. Например, чтобы проверить, что объект существует.

OPTIONS

В качестве примера простейшего HTTP сервера, можно рассмотреть wsgiref https://docs.python.org/2/library/wsgiref.html.
wsgiref в коллбек возвращать будет все.
Сокет можно привязать к определенному IP.
Например 127.0.0.1.

А если задать 0.0.0.0, то сервер будет доступен на всех интерфейсах.

## Создание скрипта установки модуля:

Чтобы сделать возможным установку Python пакета в систему, необходимо создать 
установочный скрипт.
Скрипт должен называться `setup.py` и располагаться в корне проекта:
Формат:

```python
from distutils.core import setup
import http_server

setup(
    name='sandbox',
    version='0.0.1',
    py_modules=['http_server', 'start', 'server.http_handler'],
    author='',
    author_email='',
    url='',
    description='Python library for',
)
```
Внутри можно даже компилировать C++.

чтобы установить такой пакет есть 3 варианта:
1. Скачать его из репы, затем запустить `setup.py`:

```bash
python setup.py install
```

2. Скачать его через pip

```bash
pip install -e git+http://ruch-net.ru:10022/artem/python-sandbox.git#egg=sandbox
```

3. Положить его в архиве на FTP сервер, добавить этот FTP в конфиги PIP.
И тогда он скачается:

```bash
pip install sandbox
```

## Deployment

### Capistrano

Как работает деплой:

1. Заливается код на сервер:
  1.1. Запаковать в архив и залить его через ssh.
  1.2. Зайти на машину и сделать git clone кода(git pull, если он уже есть).

2. Устанавливаются зависимости.

3. Создаются папки, необходимые для работы сервиса:
  3.1. /var/run/<service> (В ней обычно лежит pid -- файл, в который записывается ID потока сервиса,
  чтобы его можно было остановить. Потому что ты его запускаешь, как демона. И по нему же скрипт запуска отслеживает, 
  что сервис уже запущен).
  3.2. /var/log/<service>
  3.3. Создается папка с проектом, в нем меняются конфиги под эту конкретную машину.

4. Скрипт для запуска, который должен лежать в проекта, добавляется в папку /etc/init.d/
`/etc/init.d` -- это папка, в которой лежат все сервисы, которые можно запустить в системе.

5. Осуществляет запуск, или перезагрузку сервиса.

Также существует механизм отката версий. То есть Capistrano, в частности, хранит прямо на машине N предыдущих версий.

По сути, все эти действия -- это просто ssh команды.
Соответственно, Capistrano просто удаленно запускает по очереди все эти команды.

Структура папки с деплой скриптами Capistrano:

Вся эта структура создается командой:

```bash
	cap install
```

Она создает папки config, deploy, lib. Файлы deploy.rb и конфиги production.rb, staging.rb.

```
/config -- в ней лежит все, что относится к нашему деплою
	/deploy -- здесь лежат все конфиги, и все скрипты
		/shared -- здесь лежат темплейты в формате erb (это ruby формат шаблонов)
			start.sh.erb
			application.conf.erb
			...
		production.rb -- набор конфигов специфичных для хостов
		staging.rb 
		qa.rb
		dev.rb
		...

	deploy.rb -- файл со всеми задачами для деплоя
/lib/capistrano/tasks/ -- папка с кастомными задачами для деплоя. Например их можно скачивать при деплое и они
могут быть общими для нескольких проектов.

Например, туда можно добавить задачу для создания virtualenv и использовать эту задачу без изменений во всех проектах.
```

После того, как скрипт готов, можно осуществлять deploy:

```bash
	cap <configuration> deploy
```

Чтобы запустить только какой шаг, команда должна будет выглядеть так:

```bash
	cap <configuration> deploy:<name>
```

Потом, после установки нашего сервиса, его можно будет запустить командой:

```bash
	/etc/init.d/sandbox start
```

Или:

```bash
	service sandbox start
```